# .github/workflows/dvc_data_check.yml

name: DVC PR Title Check

# ä»€éº¼æ™‚å€™è§¸ç™¼é€™å€‹ workflow
on:
  pull_request:
    types: [opened, reopened, edited, synchronize] # åœ¨ PR é–‹å•Ÿã€æ›´æ–°æˆ–ç·¨è¼¯æ™‚è§¸ç™¼

jobs:
  check_dvc_title:
    runs-on: ubuntu-latest
    
    steps:
      # æ­¥é©Ÿ 1: æª¢æŸ¥ .dvc æª”æ¡ˆæ˜¯å¦æœ‰è®Šæ›´
      # é€™å€‹æ­¥é©Ÿæœƒåˆ¤æ–· PR ä¸­æ˜¯å¦æœ‰ .dvc æª”æ¡ˆçš„è®Šå‹•ï¼Œå¦‚æœæ²’æœ‰å‰‡è·³éå¾ŒçºŒæª¢æŸ¥ã€‚
      - name: Check for DVC file changes
        id: check_files
        uses: tj-actions/changed-files@v44 # ä½¿ç”¨ä¸€å€‹ marketplace action ä¾†é«˜æ•ˆåˆ¤æ–·æª”æ¡ˆè®Šæ›´
        with:
          files: |
            **/*.dvc
            .dvc/config
          
      # æ­¥é©Ÿ 2: å¦‚æœåµæ¸¬åˆ° .dvc è®Šæ›´ï¼Œå‰‡åŸ·è¡Œæ¨™é¡Œæ ¼å¼æª¢æŸ¥
      - name: Enforce DVC Update Title Format
        # åªæœ‰åœ¨å‰ä¸€æ­¥é©Ÿåµæ¸¬åˆ°è®Šå‹•æ™‚æ‰åŸ·è¡Œ
        if: steps.check_files.outputs.any_changed == 'true'
        run: |
          echo "DVC file changes detected. Checking Pull Request title..."
          
          # GitHub Actions ä¸­ï¼ŒPR æ¨™é¡Œå¯ä»¥ç›´æ¥é€šéå…§å»ºè®Šæ•¸å–å¾—
          PR_TITLE="${{ github.event.pull_request.title }}"
          
          # æ­£å‰‡è¡¨é”å¼æª¢æŸ¥ï¼š[Update dataset vX.X]
          if [[ "$PR_TITLE" =~ ^\[Update\ dataset\ v[0-9]+\.[0-9]+\]$ ]]; then
            echo "âœ… PR æ¨™é¡Œç¬¦åˆ DVC æ›´æ–°è¦ç¯„: $PR_TITLE"
          else
            echo "âŒ PR æ¨™é¡Œä¸ç¬¦åˆè¦ç¯„ï¼"
            echo "ğŸ‘‰ é æœŸæ ¼å¼æ‡‰ç‚º: [Update dataset vX.X]"
            echo "ğŸ‘‰ ç•¶å‰æ¨™é¡Œç‚º: $PR_TITLE"
            # é€€å‡ºä¸¦å›å‚³å¤±æ•—ç‹€æ…‹ï¼Œé˜»æ­¢åˆä½µ
            exit 1
          fi

